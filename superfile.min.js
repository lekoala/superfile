const BASE_CLASS="superfile",PREVIEW_CLASS="superfile-preview",PREVIEW_ACTIVE_CLASS="superfile-preview-active",CLEAR_CLASS="superfile-clear",READY_CLASS="superfile-ready",DRAG_CLASS="superfile-drag",CLONE_CLASS="superfile-clone",MAX_WIDTH=1024,MAX_HEIGHT=1024;class Superfile{constructor(e){this.inputElement=e,this.holderElement=e.parentElement,this.holderElement.classList.contains(BASE_CLASS)||(this.holderElement=this.holderElement.parentElement),this.previewElement=this.holderElement.querySelector("img."+PREVIEW_CLASS),this.clearElement=this.holderElement.querySelector("."+CLEAR_CLASS),this.disableResize=!!e.dataset.disableResize,this.maxWidth=e.dataset.maxWidth?parseInt(e.dataset.maxWidth):MAX_WIDTH,this.maxHeight=e.dataset.maxHeight?parseInt(e.dataset.maxHeight):MAX_HEIGHT,this.hideClear=!!e.dataset.hideClear,this.imageRatio=e.dataset.ratio?e.dataset.ratio.split(/\/|:/):null,this.clearElement&&this.hideClear&&(this.clearElement.dataset.originalDisplay=this.clearElement.style.display?this.clearElement.style.display:"block",this.clearElement.style.display="none"),this.previewElement&&this.previewElement.getAttribute("src")&&this.showPreview(),this.inputElement.addEventListener("change",e=>{this.processFiles(()=>{this.showPreview()})}),this.clearElement&&this.clearElement.addEventListener("click",e=>{this.clearPreview()}),this.holderElement.addEventListener("dragleave",e=>{this.onDragleave(e)}),this.holderElement.addEventListener("dragover",e=>{this.onDragover(e)}),this.holderElement.addEventListener("drop",e=>{this.onDrop(e)}),this.holderElement.classList.add(READY_CLASS)}static init(e="input[type=file]"){let t=document.querySelectorAll(e);for(let e=0;e<t.length;e++){let i=t[e];new Superfile(i)}}onDrop(e){e.stopPropagation(),e.preventDefault(),this.inputElement.files=e.dataTransfer.files,this.inputElement.dispatchEvent(new Event("change")),this.holderElement.classList.remove(DRAG_CLASS)}onDragover(e){e.stopPropagation(),e.preventDefault(),this.holderElement.classList.contains(DRAG_CLASS)||this.holderElement.classList.add(DRAG_CLASS),e.dataTransfer.dropEffect="copy"}onDragleave(e){e.stopPropagation(),e.preventDefault(),this.holderElement.classList.remove(DRAG_CLASS)}showPreview(){if(!this.previewElement)return;this.holderElement.classList.add(PREVIEW_ACTIVE_CLASS),this.clearElement&&this.clearElement.dataset.originalDisplay&&(this.clearElement.style.display=this.clearElement.dataset.originalDisplay);let e=this.previewElement.parentElement;for(let t=0;t<this.inputElement.files.length;t++){let i=this.inputElement.files[t];if(!i.type.match(/image.*/))continue;let l=e.querySelectorAll("."+PREVIEW_CLASS)[t];l||(l=this.previewElement.cloneNode(!0),l.classList.add(CLONE_CLASS),e.appendChild(l)),l.src=URL.createObjectURL(i)}}clearPreview(){if(this.previewElement){this.holderElement.classList.remove(PREVIEW_ACTIVE_CLASS),this.previewElement.removeAttribute("src"),this.hideClear&&(this.clearElement.style.display="none");let e=this.holderElement.querySelectorAll("."+CLONE_CLASS);for(let t=0;t<e.length;t++)e[t].parentElement.removeChild(e[t])}this.inputElement.value=null}resizeImage(e,t,i){let l=document.createElement("canvas"),s=0,a=0,r=t.naturalWidth,n=t.naturalHeight,h=r,o=n,d=r,m=n,E=d>this.maxWidth||m>this.maxHeight,p=d/m,c=p,g=!1;if(this.imageRatio&&(c=this.imageRatio[0]/this.imageRatio[1],g=this.imageRatio!==c),!E&&!g)return void i();g&&(p>c?d=m*c:p<c&&(m=d/c),s=(r-d)/2,a=(n-m)/2),d>this.maxWidth&&(m*=this.maxWidth/d,h*=this.maxWidth/d,o*=this.maxWidth/d,d=this.maxWidth),m>this.maxHeight&&(d*=this.maxHeight/m,h*=this.maxHeight/m,o*=this.maxHeight/m,m=this.maxHeight),d=Math.round(d),m=Math.round(m),l.width=d,l.height=m;let S=l.getContext("2d");S.imageSmoothingEnabled=!0,S.imageSmoothingQuality="high",g?S.drawImage(t,s,a,r,n,0,0,h,o):S.drawImage(t,0,0,d,m),S.canvas.toBlob(t=>{this.createProcessedFile(e,t,i)},e.type,1)}handleResizeImage(e,t){if(!e.type.match(/image.*/))return void t();if(this.disableResize)return void t();let i=new FileReader;i.onload=(i=>{let l=new Image;l.onload=(()=>{this.resizeImage(e,l,t)}),l.onerror=(e=>{}),l.src=i.target.result}),i.onerror=(e=>{console.log(e)}),i.readAsDataURL(e)}createProcessedFile(e,t,i){let l=new File([t],e.name,{type:e.type,lastModified:Date.now()}),s=new DataTransfer;for(let t=0;t<this.inputElement.files.length;t++){let i=this.inputElement.files[t];i.name===e.name?s.items.add(l):s.items.add(i)}this.inputElement.files=s.files,i()}processFiles(e){let t=this.inputElement.files;if(t.length)for(let i=0;i<t.length;i++)this.handleResizeImage(t[i],e);else e()}}export default Superfile;