const BASE_CLASS="superfile",PREVIEW_CLASS="superfile-preview",PREVIEW_ACTIVE_CLASS="superfile-preview-active",CLEAR_CLASS="superfile-clear",READY_CLASS="superfile-ready",DRAG_CLASS="superfile-drag",MAX_WIDTH=1024,MAX_HEIGHT=1024;class Superfile{constructor(e){this.inputElement=e,this.holderElement=e.parentElement,this.holderElement.classList.contains(BASE_CLASS)||(this.holderElement=this.holderElement.parentElement),this.previewElement=this.holderElement.querySelector("img."+PREVIEW_CLASS),this.clearElement=this.holderElement.querySelector("."+CLEAR_CLASS),this.disableResize=!!e.dataset.disableResize,this.maxWidth=e.dataset.maxWidth?parseInt(e.dataset.maxWidth):MAX_WIDTH,this.maxHeight=e.dataset.maxHeight?parseInt(e.dataset.maxHeight):MAX_HEIGHT,this.hideClear=!!e.dataset.hideClear,this.imageRatio=e.dataset.ratio?e.dataset.ratio.split(/\/|:/):null,this.clearElement&&this.hideClear&&(this.clearElement.dataset.originalDisplay=this.clearElement.style.display?this.clearElement.style.display:"block",this.clearElement.style.display="none"),this.previewElement&&this.previewElement.getAttribute("src")&&this.showPreview(),this.inputElement.addEventListener("change",e=>{this.processImage(()=>{this.showPreview()})}),this.clearElement&&this.clearElement.addEventListener("click",e=>{this.clearPreview()}),this.holderElement.addEventListener("dragleave",e=>{this.onDragleave(e)}),this.holderElement.addEventListener("dragover",e=>{this.onDragover(e)}),this.holderElement.addEventListener("drop",e=>{this.onDrop(e)}),this.holderElement.classList.add(READY_CLASS)}static init(e="input[type=file]"){let t=document.querySelectorAll(e);for(let e=0;e<t.length;e++){let i=t[e];new Superfile(i)}}onDrop(e){e.stopPropagation(),e.preventDefault(),this.inputElement.files=e.dataTransfer.files,this.inputElement.dispatchEvent(new Event("change")),this.holderElement.classList.remove(DRAG_CLASS)}onDragover(e){e.stopPropagation(),e.preventDefault(),this.holderElement.classList.contains(DRAG_CLASS)||this.holderElement.classList.add(DRAG_CLASS),e.dataTransfer.dropEffect="copy"}onDragleave(e){e.stopPropagation(),e.preventDefault(),this.holderElement.classList.remove(DRAG_CLASS)}showPreview(){this.previewElement&&(this.holderElement.classList.add(PREVIEW_ACTIVE_CLASS),this.clearElement&&this.clearElement.dataset.originalDisplay&&(this.clearElement.style.display=this.clearElement.dataset.originalDisplay),this.inputElement.files[0]&&(this.previewElement.src=URL.createObjectURL(this.inputElement.files[0])))}clearPreview(){this.inputElement.value=null,this.previewElement&&(this.holderElement.classList.remove(PREVIEW_ACTIVE_CLASS),this.previewElement.removeAttribute("src"),this.hideClear&&(this.clearElement.style.display="none"))}resizeImage(e,t,i){let s=document.createElement("canvas"),a=0,l=0,r=t.naturalWidth,h=t.naturalHeight,n=r,o=h,d=r,m=h,E=d>this.maxWidth||m>this.maxHeight,p=d/m,c=p,g=!1;if(this.imageRatio&&(c=this.imageRatio[0]/this.imageRatio[1],g=this.imageRatio!==c),!E&&!g)return void i();g&&(p>c?d=m*c:p<c&&(m=d/c),a=(r-d)/2,l=(h-m)/2),d>this.maxWidth&&(m*=this.maxWidth/d,n*=this.maxWidth/d,o*=this.maxWidth/d,d=this.maxWidth),m>this.maxHeight&&(d*=this.maxHeight/m,n*=this.maxHeight/m,o*=this.maxHeight/m,m=this.maxHeight),d=Math.round(d),m=Math.round(m),s.width=d,s.height=m;let u=s.getContext("2d");u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high",g?u.drawImage(t,a,l,r,h,0,0,n,o):u.drawImage(t,0,0,d,m),u.canvas.toBlob(t=>{this.createProcessedFile(e,t,i)},e.type,1)}handleResizeImage(e,t){if(!e.type.match(/image.*/))return void t();if(this.disableResize)return void t();let i=new FileReader;i.onload=(i=>{let s=new Image;s.onload=(()=>{this.resizeImage(e,s,t)}),s.onerror=(e=>{}),s.src=i.target.result}),i.onerror=(e=>{console.log(e)}),i.readAsDataURL(e)}createProcessedFile(e,t,i){let s=new File([t],e.name,{type:e.type,lastModified:Date.now()}),a=new DataTransfer;a.items.add(s),this.inputElement.files=a.files,i()}processImage(e){let t=this.inputElement.files[0];t?this.handleResizeImage(t,e):e()}}export default Superfile;