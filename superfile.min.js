var I="superfile",w="superfile-preview",y="superfile-preview-active",L="superfile-clear",A="superfile-webcam",C="superfile-ready",u="superfile-drag",R="superfile-clone";var v=class x{constructor(e){this.inputElement=e,this.holderElement=e.parentElement,this.holderElement.classList.contains(I)||(this.holderElement=this.holderElement.parentElement),this.previewElement=this.holderElement.querySelector("img."+w),this.clearElement=this.holderElement.querySelector("."+L),this.webcamElement=this.holderElement.querySelector("."+A);let t=e.dataset;this.disableResize=!!t.disableResize,this.maxWidth=t.maxWidth?parseInt(t.maxWidth):1920,this.maxHeight=t.maxHeight?parseInt(t.maxHeight):1920,this.hideClear=!!t.hideClear,this.imageRatio=t.ratio?t.ratio.split(/\/|:/):null,this.quality=t.quality?parseInt(t.quality):1,this.quality>1&&(this.quality=this.quality/100),this.clearElement&&this.hideClear&&(this.clearElement.dataset.originalDisplay=this.clearElement.style.display?this.clearElement.style.display:"block",this.clearElement.style.display="none"),this.previewElement&&this.previewElement.getAttribute("src")&&this.showPreview(),this.inputElement.addEventListener("change",this),this.clearElement&&this.clearElement.addEventListener("click",this),this.webcamElement&&this.webcamElement.addEventListener("click",this),["dragleave","dragover","drop"].forEach(i=>this.holderElement.addEventListener(i,this)),this.holderElement.classList.add(C)}dispose(){this.inputElement.removeEventListener("change",this),this.clearElement&&this.clearElement.removeEventListener("click",this),this.webcamElement&&this.webcamElement.addEventListener("click",this),["dragleave","dragover","drop"].forEach(e=>this.holderElement.removeEventListener(e,this))}static init(e="input[type=file]"){let t=document.querySelectorAll(e);for(let i=0;i<t.length;i++){let l=t[i],s=new x(l)}}handleEvent(e){this[`$${e.type}`](e)}$change(e){this.processFiles(()=>{this.showPreview()})}$click(e){let t=e.target.closest("button");t&&(t.classList.contains(L)&&this.clearPreview(),t.classList.contains(A)&&this.takePicture())}$drop(e){e.stopPropagation(),e.preventDefault(),this.inputElement.files=e.dataTransfer.files,this.inputElement.dispatchEvent(new Event("change")),this.holderElement.classList.remove(u)}$dragover(e){e.stopPropagation(),e.preventDefault(),this.holderElement.classList.contains(u)||this.holderElement.classList.add(u),e.dataTransfer.dropEffect="copy"}$dragleave(e){e.stopPropagation(),e.preventDefault(),this.holderElement.classList.remove(u)}showPreview(){if(!this.previewElement)return;this.holderElement.classList.add(y),this.clearElement&&this.clearElement.dataset.originalDisplay&&(this.clearElement.style.display=this.clearElement.dataset.originalDisplay);let e=this.previewElement.parentElement;for(let t=0;t<this.inputElement.files.length;t++){let i=this.inputElement.files[t];if(!i.type.match(/image.*/))continue;let l=e.querySelectorAll("."+w)[t];l||(l=this.previewElement.cloneNode(!0),l.classList.add(R),e.appendChild(l)),l.src=URL.createObjectURL(i)}}clearPreview(){if(this.previewElement){this.holderElement.classList.remove(y),this.previewElement.removeAttribute("src"),this.hideClear&&(this.clearElement.style.display="none");let e=this.holderElement.querySelectorAll("."+R);for(let t=0;t<e.length;t++)e[t].parentElement.removeChild(e[t])}this.inputElement.value=null}takePicture(){let e=document.createElement("video");navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then(i=>{e.srcObject=i}).catch(i=>{console.error(`An error occurred: ${i}`)});let t=i=>{e.play();let l=.8,s=e.videoWidth,r=e.videoHeight,d=s,m=r,c=s/r,a=this.getTargetRatio()||c;s*=l,r*=l,c>a?s=r*a:c<a&&(r=s/a);let n=(d-s)/2,f=(m-r)/2,h=document.createElement("canvas"),o=h.getContext("2d");h.width=s,h.height=r,o.drawImage(e,n,f,s,r,0,0,s,r),o.canvas.toBlob(E=>{this.createProcessedFile({type:"image/jpg",name:"webcam"},E,()=>{this.showPreview(),e.removeEventListener("canplay",t,!1),e.srcObject.getTracks().forEach(p=>p.stop()),e.remove()})},"image/jpg",this.quality)};e.addEventListener("canplay",t,!1)}resizeImage(e,t,i){let l=t.naturalWidth||t.width,s=t.naturalHeight||t.height,r=0,d=0,m=l,c=s,a=l,n=s,f=a>this.maxWidth||n>this.maxHeight,h=a/n,o=this.getTargetRatio()||h,E=h!==o;if(!f&&!E){i();return}E&&(h>o?a=n*o:h<o&&(n=a/o),r=(l-a)/2,d=(s-n)/2),a>this.maxWidth&&(m*=this.maxWidth/a,c*=this.maxWidth/a,n*=this.maxWidth/a,a=this.maxWidth),n>this.maxHeight&&(m*=this.maxHeight/n,c*=this.maxHeight/n,a*=this.maxHeight/n,n=this.maxHeight),a=Math.round(a),n=Math.round(n);let p=document.createElement("canvas");p.width=a,p.height=n;let g=p.getContext("2d");g.imageSmoothingEnabled=!0,g.imageSmoothingQuality="high",E?g.drawImage(t,r,d,l,s,0,0,m,c):g.drawImage(t,0,0,a,n),g.canvas.toBlob(S=>{this.createProcessedFile(e,S,i)},e.type,this.quality)}getTargetRatio(){return this.imageRatio?parseInt(this.imageRatio[0])/parseInt(this.imageRatio[1]):0}handleResizeImage(e,t){if(!e.type.match(/image.*/)){t();return}if(this.disableResize){t();return}let i=new FileReader;i.onload=l=>{let s=new Image;s.onload=()=>{this.resizeImage(e,s,t)},s.onerror=r=>{},s.src=l.target.result},i.onerror=l=>{console.log(l)},i.readAsDataURL(e)}createProcessedFile(e,t,i){let l=new File([t],e.name,{type:e.type,lastModified:Date.now()}),s=new DataTransfer;for(let r=0;r<this.inputElement.files.length;r++){let d=this.inputElement.files[r];d.name===e.name?s.items.add(l):s.items.add(d)}e.lastModified||s.items.add(l),this.inputElement.files=s.files,i()}processFiles(e){let t=this.inputElement.files;if(!t.length){e();return}for(let i=0;i<t.length;i++)this.handleResizeImage(t[i],e)}},H=v;export{H as default};
